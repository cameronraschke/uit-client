#!/bin/bash

curl 'http://10.0.0.1:8080/client/certs/uit-ca.crt' --output /usr/local/share/ca-certificates/uit-ca.crt &>/dev/null
while [ ! -f /usr/local/share/ca-certificates/uit-ca.crt ]; do
  echo "Failed to downloading CA cert, trying again..."
  curl 'http://10.0.0.1:8080/client/certs/uit-ca.crt' --output /usr/local/share/ca-certificates/uit-ca.crt &>/dev/null
  sleep 1
done
curl 'http://10.0.0.1:8080/client/certs/uit-web.crt' --output /usr/local/share/ca-certificates/uit-web.crt &>/dev/null
while [ ! -f /usr/local/share/ca-certificates/uit-web.crt ]; do
  echo "Failed to download web cert, trying again..."
  curl 'http://10.0.0.1:8080/client/certs/uit-web.crt' --output /usr/local/share/ca-certificates/uit-web.crt &>/dev/null
  sleep 1
done
update-ca-certificates

curl --silent 'http://10.0.0.1:8080/client/api/configs/uit-client' | sed 's/\\n/\n/g' | sed 's/^"//g' | sed 's/^[[:space:]]//g' > /etc/uit-client.conf
while [ ! -f /etc/uit-client.conf ]; do
  echo "Failed to download client config, trying again..."
  curl --silent 'http://10.0.0.1:8080/client/api/configs/uit-client' | sed 's/\\n/\n/g' | sed 's/^"//g' | sed 's/^[[:space:]]//g' > /etc/uit-client.conf
  sleep 1
done

curl --silent 'http://10.0.0.1:8080/client/src/go-latest.linux-amd64.tar.gz' --output /tmp/go-latest.linux-amd64.tar.gz
while [ ! -f /tmp/go-latest.linux-amd64.tar.gz ]; do
  echo "Failed to download Go, trying again..."
  curl --silent 'http://10.0.0.1:8080/client/src/go-latest.linux-amd64.tar.gz' --output /tmp/go-latest.linux-amd64.tar.gz
  sleep 1
done
rm -rf /usr/local/go
tar -C /usr/local -xzf /tmp/go-latest.linux-amd64.tar.gz
export PATH="${PATH}:/usr/local/go/bin"


## Server config
unset configArr
declare -A configArr

# Get config value from file
getConfigValue() {
  local key="$1"
  local trim_spaces="${2:-true}"
  local value
  value=$(sed -n -e "s|^${key}=||p" /etc/uit-client.conf | head -n1)
  if [[ "$trim_spaces" == "true" ]]; then
    value="${value#"${value%%[![:space:]]*}"}"
    value="${value%"${value##*[![:space:]]}"}"
  fi
  printf '%s' "$value"
}

# Load config values (values that need spaces preserved are marked with 'false')
configArr[UIT_CLIENT_DB_USER]=$(getConfigValue "UIT_CLIENT_DB_USER")
configArr[UIT_CLIENT_DB_PASSWD]=$(getConfigValue "UIT_CLIENT_DB_PASSWD")
configArr[UIT_CLIENT_DB_NAME]=$(getConfigValue "UIT_CLIENT_DB_NAME")
configArr[UIT_CLIENT_DB_HOST]=$(getConfigValue "UIT_CLIENT_DB_HOST")
configArr[UIT_CLIENT_DB_PORT]=$(getConfigValue "UIT_CLIENT_DB_PORT")
configArr[UIT_CLIENT_NTP_HOST]=$(getConfigValue "UIT_CLIENT_NTP_HOST")
configArr[UIT_CLIENT_PING_HOST]=$(getConfigValue "UIT_CLIENT_PING_HOST")
configArr[UIT_SERVER_HOSTNAME]=$(getConfigValue "UIT_SERVER_HOSTNAME")
configArr[UIT_WEB_HTTP_HOST]=$(getConfigValue "UIT_WEB_HTTP_HOST")
configArr[UIT_WEB_HTTP_PORT]=$(getConfigValue "UIT_WEB_HTTP_PORT")
configArr[UIT_WEB_HTTPS_HOST]=$(getConfigValue "UIT_WEB_HTTPS_HOST")
configArr[UIT_WEB_HTTPS_PORT]=$(getConfigValue "UIT_WEB_HTTPS_PORT")
configArr[UIT_WEBMASTER_NAME]=$(getConfigValue "UIT_WEBMASTER_NAME")

for i in ${!configArr[@]}; do
  while IFS= read -r -d '' file; do
    if [[ -f $file ]]; then
      val="${configArr[$i]}"
      [[ "$i" == "UIT_CLIENT_DB_PASSWD" ]] && printf 'DEBUG %s -> [%s] -> %s\n' "$i" "$(printf %s "$val" | xxd -p)" "$file" >&2
      val="${val//\\/\\\\}"
      val="${val//&/\\&}"
      val="${val//|/\\|}"
      sed -i "s|${i}|${val}|g" "$file"
      
      sed -i "s|${i}|${sanitizedValue}|g" "$file"
    else
      echo "File ${file} does not exist. Exiting..."
      exit 1
    fi
  done < <(find /usr/sbin/ -type f -name 'uit-*' -print0; find /opt/uit-toolbox/ -type f -print0)
done

/usr/bin/chmod 700 /usr/sbin/uit-*
/usr/bin/chown root:root /usr/sbin/uit-*
/usr/bin/chmod 750 /opt/uit-toolbox/ -R
/usr/bin/chown root:root /opt/uit-toolbox/ -R